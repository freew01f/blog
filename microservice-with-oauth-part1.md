# Part 1 - ç†è®ºç›¸å…³

ä½œè€… freewolf

## å…³é”®è¯
`å¾®æœåŠ¡`ã€`Spring Cloud`ã€`OAuth 2.0`ã€`JWT`ã€`Spring Security`ã€`SSO`ã€`UAA`

## å†™åœ¨å‰é¢

ä½œä¸ºä»ä¸šäº†åå¤šå¹´çš„ITè¡Œä¸šå’Œç¨‹åºçš„è€å¸æœºï¼Œä»Šå¤©å¦‚æœä½ è¯´ä½ ä¸æ‡‚å¾®æœåŠ¡ï¼Œéƒ½ä¸å¥½æ„æ€è¯´è‡ªå·±çš„åšè½¯ä»¶çš„ã€‚SOAå–Šäº†å¤šå¹´ï¼Œæ— äººä¸çŸ¥ï¼Œä½†åˆæœ‰å¤šå°‘ç³»ç»Ÿå¼€å‘çœŸæ­£çš„SOAäº†å‘¢ï¼Ÿä½†æ˜¯å¥½åƒä¸€å¤œä¹‹é—´æ‰€æœ‰äººéƒ½æŠ•å…¥äº†å¾®æœåŠ¡çš„æ€€æŠ±ã€‚

ä½œä¸ºç›®å‰æœ€ä¸»æµçš„â€œå¾®æœåŠ¡æ¡†æ¶â€ï¼ŒSpring Cloudå‘å±•é€Ÿåº¦å¾ˆå¿«ï¼Œæˆä¸ºäº†æœ€å…¨é¢çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚ä¸ç®¡ä»€ä¹ˆè½¯ä»¶ä½“ç³»ï¼Œä»€ä¹ˆæ¡†æ¶ï¼Œå®‰å…¨æ°¸è¿œæ˜¯ä¸å¯èƒ½ç»•å¼€çš„è¯é¢˜ï¼Œæˆ‘ä¹ŸæŠŠå®ƒä½œä¸ºæˆ‘æœ€è¿‘ä¸€æ®µæ—¶é—´ç ”ç©¶å¾®æœåŠ¡çš„å¼€ç¯‡ã€‚

è€è¯é¢˜ï¼â€œå¦‚ä½•æ‰èƒ½åœ¨å¾®æœåŠ¡ä½“ç³»ä¸­ä¿è¯å®‰å…¨ï¼Ÿâ€ï¼Œä¸ºäº†è¾¾æˆç›®æ ‡ï¼Œè¿™é‡Œé‡‡ç”¨ä¸€ä¸ªç®€å•è€Œå¯è¡Œæ–¹å¼æ¥ä¿æŠ¤`Spring Cloud`ä¸­æœåŠ¡çš„å®‰å…¨ï¼Œä¹Ÿå°±æ˜¯å»ºç«‹ç»Ÿä¸€çš„ç”¨æˆ·æˆæƒä¸­å¿ƒã€‚

è¿™é‡Œè¡¥å……è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯`Authenticationï¼ˆè®¤è¯ï¼‰`å’Œ`Authorizationï¼ˆé‰´æƒï¼‰`ï¼Œå…¶å®å¾ˆç®€å•ï¼Œè®¤è¯å…³å¿ƒä½ æ˜¯è°ï¼Œé‰´æƒå…³å¿ƒä½ èƒ½å¹²ä»€ä¹ˆã€‚ä¸¾ä¸ªå¤§å®¶ä¸€è‡´éƒ½å†è¯´çš„ä¾‹å­ï¼Œå¦‚æœä½ å»æœºåœºä¹˜æœºï¼Œä½ æŒæœ‰çš„æŠ¤ç…§ä»£è¡¨ä½ çš„èº«ä»½ï¼Œè¿™æ˜¯è®¤è¯ï¼Œä½ çš„æœºç¥¨å°±æ˜¯ä½ çš„æƒé™ï¼Œä½ èƒ½å¹²ä»€ä¹ˆã€‚

å­¦ä¹ å¾®æœåŠ¡å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„æ¢ç´¢è¿‡ç¨‹ï¼Œè¿™ä¸å¾—å­¦ä¹ å¾ˆå¤šæ–°çš„çŸ¥è¯†ï¼Œå…¶å®ä¸ç®¡æ˜¯æŒ‰ç…§DDDï¼ˆDomain Driven Designï¼‰é¢†åŸŸé©±åŠ¨è®¾è®¡ä¸­é¢†åŸŸæ¨¡å‹çš„æ–¹å¼ï¼Œè¿˜æ˜¯å°†å¾®æœåŠ¡æ‹†åˆ†æˆæ›´å°çš„ç²’åº¦ã€‚éƒ½ä¼šé‡åˆ°å¾ˆå¤šæ–°çš„é—®é¢˜å’Œä»¥å‰ä¸€ç›´éƒ½æ²¡è§£å†³å¾ˆå¥½çš„é—®é¢˜ã€‚éšç€ä¸æ–­çš„æ€è€ƒï¼Œéšç€ç†Ÿæ‚‰`Facebook/GitHub/AWS`è¿™äº›æœºæ„æ˜¯å¦‚ä½•ä¿æŠ¤å†…éƒ¨èµ„æºï¼Œç­”æ¡ˆä¹Ÿé€æ¸æµ®å‡ºæ°´é¢ã€‚

ä¸ºäº†é«˜æ•ˆçš„å®ç°è¿™ä¸ªç›®æ ‡ï¼Œè¿™é‡Œé‡‡ç”¨`OAuth 2`å’Œ`JWT(JSON Web Tokens)`æŠ€æœ¯ä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œ

## ä¸ºä»€ä¹ˆä½¿ç”¨`OAuth 2`

å°½ç®¡å¾®æœåŠ¡åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­è¿˜ç®—ä¸€ä¸ªæ–°é²œäº‹ç‰©ï¼Œä½†æ˜¯`OAuth 2`å·²ç»æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„æˆæƒæŠ€æœ¯ï¼Œå®ƒè®©Webå¼€å‘è€…åœ¨è‡ªå·±æä¾›æœåŠ¡ä¸­ï¼Œç”¨ä¸€ç§å®‰å…¨çš„æ–¹å¼ç›´è®¿é—®`Google/Facebook/GitHub`å¹³å°ç”¨æˆ·ä¿¡æ¯ã€‚ä½†åœ¨æˆ‘å¼€å§‹é˜è¿°ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘å°†æ­å¼€èšç„¦åˆ°æœ¬æ–‡çœŸæ­£çš„ä¸»é¢˜ï¼š`äº‘å®‰å…¨`

é‚£ä¹ˆåœ¨äº‘æœåŠ¡ä¸­å¯¹ç”¨æˆ·è®¿é—®èµ„æºçš„æ§åˆ¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ€ä¹ˆåšå‘¢ï¼Ÿç„¶æˆ‘ä¸¾ä¸€äº›å¤§å®¶ä¼¼ä¹éƒ½ç”¨è¿‡çš„ä½†åˆä¸æ˜¯å¾ˆå®Œç¾çš„ä¾‹å­ã€‚

æˆ‘ä»¬å¯ä»¥è®¾ç½®è¾¹ç•ŒæœåŠ¡å™¨æˆ–è€…å¸¦è®¤è¯åŠŸèƒ½çš„åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå‡è®¾æ‰€æœ‰è®¿é—®è¯·æ±‚éƒ½å‘ç»™å®ƒã€‚é€šè¿‡è®¤è¯åï¼Œè½¬å‘ç»™å†…éƒ¨ç›¸åº”çš„æœåŠ¡å™¨ã€‚ä¸€èˆ¬åœ¨`Spring MVC Security`å¼€å‘ä¸­å‡ ä¹éƒ½ä¼šè¿™æ ·åšçš„ã€‚ä½†è¿™å¹¶ä¸å®‰å…¨ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œä¸€æ—¦æ˜¯æœ‰äººä»å†…éƒ¨æ”»å‡»ï¼Œä½ çš„æ•°æ®æ¯«æ— å®‰å…¨æ€§ã€‚

å…¶ä»–æ–¹å¼:æˆ‘ä»¬ä¸ºæ‰€æœ‰æœåŠ¡å»ºç«‹ç»Ÿä¸€çš„æƒé™æ•°æ®åº“ï¼Œå¹¶åœ¨æ¯æ¬¡è¯·æ±‚å‰å¯¹ç”¨æˆ·è¿›è¡Œé‰´æƒï¼Œå¬èµ·æ¥æŸäº›æ–¹é¢çš„ç¡®æœ‰ç‚¹æ„šè ¢ï¼Œä½†å®é™…ä¸Šè¿™ç¡®å®æ˜¯ä¸€ä¸ªå¯è¡Œçš„å®‰å…¨æ–¹æ¡ˆã€‚

æ›´å¥½çš„æ–¹å¼: ç”¨æˆ·é€šè¿‡æˆæƒæœåŠ¡æ¥å®ç°é‰´æƒï¼ŒæŠŠç”¨æˆ·è®¿é—®Sessionæ˜ å°„æˆä¸€ä¸ª`Token`ã€‚æ‰€æœ‰è¿œç¨‹è®¿é—®èµ„æºæœåŠ¡å™¨ç›¸å…³çš„APIå¿…é¡»æä¾›`Token`ã€‚ç„¶åèµ„æºæœåŠ¡å™¨è®¿é—®æˆæƒæœåŠ¡æ¥è¯†åˆ«`Token`ï¼Œå¾—çŸ¥`Token`å±äºå“ªä¸ªç”¨æˆ·ï¼Œå¹¶äº†è§£é€šè¿‡è¿™ä¸ªTokenå¯ä»¥è®¿é—®ä»€ä¹ˆèµ„æºã€‚

è¿™å¬èµ·æ¥æ˜¯ä¸ªä¸é”™çš„æ–¹æ¡ˆï¼Œå¯¹ä¸ï¼Ÿä½†æ˜¯å¦‚ä½•ä¿è¯`Token`çš„å®‰å…¨ä¼ è¾“ï¼Ÿå¦‚ä½•åŒºåˆ†æ˜¯ç”¨æˆ·è®¿é—®è¿˜æ˜¯å…¶ä»–æœåŠ¡è®¿é—®ï¼Ÿè¿™è‚¯å®šæ˜¯æˆ‘ä»¬å…³å¿ƒçš„é—®é¢˜ã€‚

æ‰€ä»¥ä¸Šè¿°ç§ç§é—®é¢˜è®©æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨`OAuth 2`ï¼Œå…¶å®è®¿é—®`Facebook/Google`çš„æ•æ„Ÿæ•°æ®å’Œè®¿é—®æˆ‘ä»¬è‡ªå·±åç«¯å—ä¿æŠ¤æ•°æ®æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå¹¶ä¸”ä»–ä»¬å·²ç»ä½¿ç”¨è¿™æ ·çš„è§£å†³æ–¹æ¡ˆå¾ˆå¤šå¹´ï¼Œæˆ‘ä»¬åªè¦éµå¾ªè¿™äº›æ–¹æ³•å°±å¥½äº†ã€‚

## `OAuth 2`æ˜¯å¦‚ä½•å·¥ä½œçš„

å¦‚æœä½ äº†è§£`OAuth 2`ç›¸å…³çš„åŸç†ï¼Œé‚£ä¹ˆåœ¨éƒ¨ç½²`OAuth 2`æ˜¯éå¸¸å®¹æ˜“çš„ã€‚
è®©æˆ‘ä»¬æè¿°ä¸‹è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œâ€œ`æŸApp`å¸Œæœ›è·å¾—`Tom`åœ¨`Facebook`ä¸Šç›¸å…³çš„æ•°æ®â€

OAuth 2 åœ¨æ•´ä¸ªæµç¨‹ä¸­æœ‰å››ç§è§’è‰²:
- èµ„æºæ‹¥æœ‰è€…(Resource Owner) - è¿™é‡Œæ˜¯Tom
- èµ„æºæœåŠ¡å™¨(Resource Server) - è¿™é‡Œæ˜¯Facebook
- æˆæƒæœåŠ¡å™¨(Authorization Server) - è¿™é‡Œå½“ç„¶è¿˜æ˜¯Facebookï¼Œå› ä¸ºFacebookæœ‰ç›¸å…³æ•°æ®
- å®¢æˆ·ç«¯(Client) - è¿™é‡Œæ˜¯æŸApp

å½“`Tom`è¯•å›¾ç™»å½•`Facebook`ï¼Œ`æŸApp`å°†ä»–é‡å®šå‘åˆ°`Facebook`çš„æˆæƒæœåŠ¡å™¨ï¼Œå½“`Tom`ç™»å½•æˆåŠŸï¼Œå¹¶ä¸”è®¸å¯è‡ªå·±çš„Emailå’Œä¸ªäººä¿¡æ¯è¢«`æŸApp`è·å–ã€‚è¿™ä¸¤ä¸ªèµ„æºè¢«å®šä¹‰æˆä¸€ä¸ª`Scopeï¼ˆæƒé™èŒƒå›´ï¼‰`ï¼Œä¸€æ—¦å‡†è®¸ï¼Œ`æŸApp`çš„å¼€å‘è€…å°±å¯ä»¥ç”³è¯·è®¿é—®æƒé™èŒƒå›´ä¸­å®šä¹‰çš„è¿™ä¸¤ä¸ªèµ„æºã€‚

```text
+--------+                               +---------------+
|        |--(A)- Authorization Request ->|   Resource    |
|        |                               |     Owner     |
|        |<-(B)-- Authorization Grant ---|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(C)-- Authorization Grant -->| Authorization |
| Client |                               |     Server    |
|        |<-(D)----- Access Token -------|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(E)----- Access Token ------>|    Resource   |
|        |                               |     Server    |
|        |<-(F)--- Protected Resource ---|               |
+--------+                               +---------------+
```

`Tom`å…è®¸äº†æƒé™è¯·æ±‚ï¼Œå†æ¬¡é€šè¿‡é‡å®šå‘è¿”å›`æŸApp`ï¼Œé‡å®šå‘è¿”å›æ—¶æºå¸¦äº†ä¸€ä¸ª`Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰`ï¼Œæ¥ä¸‹æ¥`æŸApp`å°±å¯ä»¥é€šè¿‡è¿™ä¸ª`Access Token`ä»`Facebook`ç›´æ¥è·å–ç›¸å…³çš„æˆæƒèµ„æºï¼ˆä¹Ÿå°±æ˜¯Emailå’Œä¸ªäººä¿¡æ¯ï¼‰ï¼Œè€Œæ— éœ€é‡æ–°åš`Tom`ç›¸å…³çš„é‰´æƒã€‚è€Œä¸”æ¯å½“`Tom`ç™»å½•äº†`æŸApp`ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¹‹å‰è·å¾—çš„`Access Token`ï¼Œç›´æ¥è·å–ç›¸å…³æˆæƒèµ„æºã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¦‚ä½•ç›´æ¥å°†ä»¥ä¸Šå†…å®¹ç”¨äºå®é™…çš„ä¾‹å­ä¸­ï¼Ÿ`OAuth 2`ååˆ†å‹å¥½ï¼Œå¹¶å®¹æ˜“éƒ¨ç½²ï¼Œæ‰€æœ‰äº¤äº’éƒ½æ˜¯å…³äºå®¢æˆ·ç«¯å’Œæƒé™èŒƒå›´çš„ã€‚

- `OAuth 2`ä¸­çš„`å®¢æˆ·ç«¯`å’Œ`æƒé™èŒƒå›´`å’Œæˆ‘ä»¬å¹³æ—¶çš„ç”¨æˆ·å’Œæƒé™æ˜¯å¦ç›¸åŒï¼Ÿ
- æˆ‘éœ€è¦å°†æˆæƒæ˜ å°„åˆ°æƒé™èŒƒå›´ä¸­æˆ–å°†ç”¨æˆ·æ˜ å°„åˆ°å®¢æˆ·ç«¯ä¸­ï¼Ÿ
- ä¸ºä»€ä¹ˆæˆ‘éœ€è¦å®¢æˆ·ç«¯ï¼Ÿ

ä½ ä¹Ÿè®¸åœ¨ä¹‹å‰åœ¨ç±»ä¼¼çš„ä¼ä¸šçº§å¼€å‘æ¡ˆä¾‹ä¸­å°è¯•æ˜ å°„è¿‡ç›¸å…³çš„è§’è‰²ã€‚è¿™ä¼šå¾ˆæ£˜æ‰‹ï¼

ä»»ä½•ç±»å‹çš„åº”ç”¨éƒ½æä¾›ç”¨æˆ·ç™»å½•ï¼Œç™»å½•ç»“æœæ˜¯ä¸€ä¸ª`Access Token`ï¼Œæ‰€æœ‰çš„ä¹‹åçš„APIè°ƒç”¨éƒ½å°†è¿™ä¸ª`Access Token`åŠ å…¥HTTPè¯·æ±‚å¤´ä¸­ï¼Œè¢«è°ƒç”¨æœåŠ¡å»æˆæƒæœåŠ¡å™¨éªŒè¯`Access Token`å¹¶è·å–è¯¥Tokenå¯è®¿é—®çš„æƒé™ä¿¡æ¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‰€æœ‰æœåŠ¡çš„è®¿é—®éƒ½ä¼šè¯·æ±‚å¦å¤–çš„æœåŠ¡æ¥å®Œæˆé‰´æƒã€‚

## æƒé™èŒƒå›´å’Œè§’è‰²ï¼Œå®¢æˆ·ç«¯å’Œç”¨æˆ·

åœ¨`OAuth 2`ä¸­ï¼Œä½ å¯ä»¥å®šä¹‰å“ªä¸ªåº”ç”¨ï¼ˆç½‘ç«™ã€ç§»åŠ¨å®¢æˆ·ç«¯ã€æ¡Œé¢åº”ç”¨ã€å…¶ä»–ï¼‰å¯ä»¥è®¿é—®é‚£äº›èµ„æºã€‚è¿™é‡Œåªæœ‰ä¸€ä¸ªå°ºå¯¸ï¼Œæ¥è‡ªå“ªé‡Œçš„å“ªä¸ªç”¨æˆ·å¯ä»¥è®¿é—®é‚£äº›æ•°æ®ï¼Œå½“ç„¶ä¹Ÿæ˜¯å“ªä¸ªåº”ç”¨æˆ–è€…æœåŠ¡å¯ä»¥è®¿é—®é‚£äº›èµ„æºã€‚æ¢ä¸€ç§è¯´æ³•ï¼Œæƒé™èŒƒå›´å°±æ˜¯æ§åˆ¶é‚£äº›ç«¯ç‚¹å¯¹å®¢æˆ·ç«¯å¯è§ï¼Œæˆ–è€…ç”¨æˆ·æ ¹æ®ä»–çš„æƒé™æ¥è·å–ç›¸å…³çš„æ•°æ®ã€‚

åœ¨ä¸€ä¸ªåœ¨çº¿å•†åº—ä¸­ï¼Œå‰ç«¯å¯ä»¥çœ‹åšä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¯ä»¥è®¿é—®å•†å“ã€è®¢å•å’Œå®¢æˆ·ä¿¡æ¯ï¼Œä½†åç«¯å¯ä»¥å…³äºç‰©æµå’ŒåˆåŒç­‰ï¼Œå¦ä¸€æ–¹é¢ï¼Œç”¨æˆ·å¯ä»¥è®¿é—®ä¸€ä¸ªæœåŠ¡ä½†å¹¶ä¸æ˜¯å…¨éƒ¨çš„æ•°æ®ï¼Œè¿™å¯ä»¥æ˜¯å› ä¸ºç”¨æˆ·æ­£åœ¨ä½¿ç”¨Webåº”ç”¨ï¼Œå½“ä»–ä¸èƒ½çš„æ—¶å€™ï¼Œå…¶ä»–ç”¨æˆ·å´å¯ä»¥ã€‚æœåŠ¡ä¹‹é—´çš„è®¿é—®æ—¶æˆ‘ä»¬è¦è®¨è®ºçš„å¦ä¸€ä¸ªç»´åº¦ã€‚å¦‚æœä½ ç†Ÿæ‚‰æ•°å­¦ï¼Œæˆ‘å¯ä»¥è¯´åœ¨`OAuth 2`ä¸­ï¼Œå®¢æˆ·ç«¯-æƒé™èŒƒå›´å…³ç³»æ˜¯çº¿æ€§ç‹¬ç«‹äºç”¨æˆ·-æƒé™å…³ç³»ã€‚

## ä¸ºä»€ä¹ˆæ˜¯JWT

`OAuth 2`å¹¶ä¸å…³å¿ƒå»å“ªæ‰¾`Access Token`å’ŒæŠŠå®ƒå­˜åœ¨ä»€ä¹ˆåœ°æ–¹çš„ï¼Œç”Ÿæˆéšæœºå­—ç¬¦ä¸²å¹¶ä¿å­˜`Token`ç›¸å…³çš„æ•°æ®åˆ°è¿™äº›å­—ç¬¦ä¸²ä¸­ä¿å­˜å¥½ã€‚é€šè¿‡ä¸€ä¸ªä»¤ç‰Œç«¯ç‚¹ï¼Œå…¶ä»–æœåŠ¡å¯èƒ½ä¼šå…³å¿ƒè¿™ä¸ª`Token`æ˜¯å¦æœ‰æ•ˆï¼Œå®ƒå¯ä»¥é€šè¿‡å“ªäº›æƒé™ã€‚è¿™å°±æ˜¯ç”¨æˆ·ä¿¡æ¯URLæ–¹æ³•ï¼ŒæˆæƒæœåŠ¡å™¨ä¸ºäº†è·å–ç”¨æˆ·ä¿¡æ¯è½¬æ¢ä¸ºèµ„æºæœåŠ¡å™¨ã€‚

å½“æˆ‘ä»¬è°ˆåŠå¾®æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ª`Token`å­˜å‚¨çš„æ–¹å¼ï¼Œæ¥ä¿è¯æˆæƒæœåŠ¡å™¨å¯ä»¥è¢«æ°´å¹³æ‰©å±•ï¼Œå°½ç®¡è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„ä»»åŠ¡ã€‚æ‰€æœ‰è®¿é—®å¾®æœåŠ¡èµ„æºçš„è¯·æ±‚éƒ½åœ¨Http Headerä¸­æºå¸¦`Token`ï¼Œè¢«è®¿é—®çš„æœåŠ¡æ¥ä¸‹æ¥å†å»è¯·æ±‚æˆæƒæœåŠ¡å™¨éªŒè¯`Token`çš„æœ‰æ•ˆæ€§ï¼Œç›®å‰è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤æ¬¡æˆ–è€…æ›´å¤šæ¬¡çš„è¯·æ±‚ï¼Œä½†è¿™æ˜¯ä¸ºäº†å®‰å…¨æ€§ä¹Ÿæ²¡ä»€ä¹ˆå…¶ä»–åŠæ³•ã€‚ä½†æ‰©å±•`Token`å­˜å‚¨ä¼šå¾ˆå¤§å½±å“æˆ‘ä»¬ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Œè¿™æ˜¯æˆ‘ä»¬å¼•å…¥`JWTï¼ˆè¯»jotï¼‰`çš„åŸå› ã€‚

```text
+-----------+                                     +-------------+
|           |       1-Request Authorization       |             |
|           |------------------------------------>|             |
|           |     grant_type&username&password    |             |--+
|           |                                     |Authorization|  | 2-Gen
|  Client   |                                     |Service      |  |   JWT
|           |       3-Response Authorization      |             |<-+
|           |<------------------------------------| Private Key |
|           |    access_token / refresh_token     |             |
|           |    token_type / expire_in / jti     |             |
+-----------+                                     +-------------+
```

ç®€çŸ­æ¥è¯´ï¼Œå“åº”ä¸€ä¸ªç”¨æˆ·è¯·æ±‚æ—¶ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å’ŒæˆæƒèŒƒå›´åºåˆ—åŒ–åæ”¾å…¥ä¸€ä¸ªJSONå­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨Base64è¿›è¡Œç¼–ç ï¼Œæœ€ç»ˆåœ¨æˆæƒæœåŠ¡å™¨ç”¨`ç§é’¥`å¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œç­¾åï¼Œå¾—åˆ°ä¸€ä¸ª`JSON Web Token`ï¼Œæˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨`Access Token`ä¸€æ ·çš„ç›´æ¥ä½¿ç”¨å®ƒï¼Œå‡è®¾å…¶ä»–æ‰€æœ‰çš„èµ„æºæœåŠ¡å™¨éƒ½å°†æŒæœ‰ä¸€ä¸ªRSAå…¬é’¥ã€‚å½“èµ„æºæœåŠ¡å™¨æ¥æ”¶åˆ°è¿™ä¸ªåœ¨Http Headerä¸­å­˜æœ‰`Token`çš„è¯·æ±‚ï¼Œèµ„æºæœåŠ¡å™¨å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ª`Token`ï¼Œå¹¶éªŒè¯å®ƒæ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„ç§é’¥ç­¾åï¼ˆæ˜¯å¦ç»è¿‡æˆæƒæœåŠ¡å™¨ç­¾åï¼Œä¹Ÿå°±æ˜¯`éªŒç­¾`ï¼‰ã€‚`éªŒç­¾`é€šè¿‡ï¼Œååºåˆ—åŒ–åå°±æ‹¿åˆ°`OAuth 2`çš„éªŒè¯ä¿¡æ¯ã€‚

éªŒè¯æœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯å¯ä»¥æ˜¯ä»¥ä¸‹å†…å®¹ï¼š
- access_token - è®¿é—®ä»¤ç‰Œï¼Œç”¨äºèµ„æºè®¿é—®
- refresh_token - å½“è®¿é—®ä»¤ç‰Œå¤±æ•ˆï¼Œä½¿ç”¨è¿™ä¸ªä»¤ç‰Œé‡æ–°è·å–è®¿é—®ä»¤ç‰Œ  
- token_type - ä»¤ç‰Œç±»å‹ï¼Œè¿™é‡Œæ˜¯`Bearer`ä¹Ÿå°±æ˜¯åŸºæœ¬HTTPè®¤è¯
- expire_in - è¿‡æœŸæ—¶é—´
- jti - JWT ID

ç”±äº`Access Token`æ˜¯`Base64ç¼–ç `ï¼Œåç¼–ç åå°±æ˜¯ä¸‹é¢çš„æ ¼å¼ï¼Œæ ‡å‡†çš„JWTæ ¼å¼ã€‚ä¹Ÿå°±æ˜¯`Header`ã€ `Payload`ã€`Signature`ä¸‰éƒ¨åˆ†ã€‚
```
{
  "alg":"RS256",
  "typ":"JWT"
}
{
  "exp": 1492873315,
  "user_name": "reader",
  "authorities": [
    "AURH_READ"
  ],
  "jti": "8f2d40eb-0d75-44df-a8cc-8c37320e3548",
  "client_id": "web_app",
  "scope": [
    "FOO"
  ]
}
&:lÆ§sî‘)Û¡-[+
F"2"KØ¢8Û“Ù:u9Ù´Ì¯Ş¡ 9Q32ZÆŒŞ¿$ec{3mxJhï‚»0DFåº–[!ë€­N)ã¥”knVVÄ–V|å¤»×„Eã«}Åœf9>'<è•±êµ¤BÛ‹ĞµÏµovè™€DÓ¨8C4K}EmÂŞ¢	YVcaqIW&*uÊuï”›b!×*Å¤\ÕŸ-{Ê–XÜŒWTq
```
ä½¿ç”¨JWTå¯ä»¥ç®€å•çš„ä¼ è¾“`Token`ï¼Œç”¨`RSAç­¾å`ä¿è¯`Token`å¾ˆéš¾è¢«ä¼ªé€ ã€‚`Access Token`å­—ç¬¦ä¸²ä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæƒé™èŒƒå›´ï¼Œæˆ‘ä»¬æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯éƒ½æœ‰äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ç»´æŠ¤`Token`å­˜å‚¨ï¼Œèµ„æºæœåŠ¡å™¨ä¹Ÿä¸å¿…è¦æ±‚`Token`æ£€æŸ¥ã€‚

```text
+-----------+                                    +-----------+
|           |       1-Request Resource           |           |
|           |----------------------------------->|           |
|           | Authorization: bearer Access Token |           |--+
|           |                                    | Resource  |  | 2-Verify
|  Client   |                                    | Service   |  |  Token
|           |       3-Response Resource          |           |<-+
|           |<-----------------------------------| Public Key|
|           |                                    |           |
+-----------+                                    +-----------+
```

æ‰€ä»¥ï¼Œåœ¨å¾®æœåŠ¡ä¸­ä½¿ç”¨`OAuth 2`ï¼Œä¸ä¼šå½±å“åˆ°æ•´ä½“æ¶æ„çš„å¯æ‰©å±•æ€§ã€‚æ·¡ç„¶è¿™é‡Œè¿˜æœ‰ä¸€äº›é—®é¢˜æ²¡æœ‰æ¶‰åŠï¼Œä¾‹å¦‚`Access Token`è¿‡æœŸåï¼Œä½¿ç”¨`Refresh Token`åˆ°è®¤è¯æœåŠ¡å™¨é‡æ–°è·å–`Access Token`ç­‰ï¼Œåé¢ä¼šæœ‰å…·ä½“çš„ä¾‹å­æ¥å±•å¼€è®¨è®ºè¿™äº›é—®é¢˜ã€‚

å¦‚æœæ‚¨æ„Ÿå…´è¶£ï¼Œåé¢è¿˜ä¼šæœ‰å®ç°éƒ¨åˆ†ï¼Œæ•¬è¯·æœŸå¾…~

> ç”±äº http://asciiflow.com/ æµç¨‹å›¾ä½¿ç”¨ä¸­æ–‡å°±æ— æ³•å¯¹é½äº†ï¼Œæœ¬æ–‡ä¸­æµç¨‹å›¾éƒ½æ˜¯è‹±æ–‡äº†~
