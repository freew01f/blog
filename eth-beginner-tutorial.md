# å»ºç«‹åŸºäºä»¥å¤ªåŠçš„ç§æœ‰ç½‘ç»œå’Œæ™ºèƒ½åˆçº¦

> æœ¬æ–‡æ¬¢è¿è½¬è½½ï¼Œè½¬è½½è¯·æ ‡æ˜å‡ºå¤„
>
> freewolf èµ„æ·±ITä»ä¸šè€…ï¼Œå…³æ³¨`å¾®æœåŠ¡`ã€`åŒºå—é“¾`ã€`æ•æ·å¼€å‘`ã€`å‰ç«¯æŠ€æœ¯`ç­‰ï¼Œä¸æ˜¯å¤§ç¥ï¼Œåªæ˜¯å‡ºäºçƒ­çˆ±ã€‚æœ‰é—®é¢˜å¯ä»¥åˆ° https://github.com/freew01f/blog è¿›è¡Œäº¤æµã€‚
>
> å‘å¸ƒæ—¶é—´ `BiTCoin #480499`


## å†™åœ¨å‰é¢

æœ€è¿‘ä¸€æ®µæ—¶é—´ä¸€ç›´å…³æ³¨åŒºå—é“¾çš„ç›¸å…³çš„é¢†åŸŸå’ŒçŸ¥è¯†ï¼Œä»Šå¤©æœ¬æ¥æƒ³å¸®åŠ©å°ä¼™ä¼´å»ºç«‹ä¸€ä¸ªåŸºäºä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦Demoï¼Œå‘ç°å¾ˆå¤šè¿‡å»çš„æ–‡æ¡£éƒ½å·²ç»è¿‡æ—¶äº†ï¼Œæ— æ³•æ­£å¸¸å·¥ä½œã€‚é‚£å°±åªèƒ½è‡ªå·±é€ ä¸ªè½®å­ï¼Œå¼„ä¸ªç‰ˆæœ¬æ–°ä¸€äº›å¸®åŠ©å¤§å®¶å…¥é—¨ã€‚

> æœ¬æ–‡ä»¥æµç¨‹`tutorial`ä¸ºä¸»ï¼Œä¸è¿‡å¤šå»è®²æŠ€æœ¯åŸç†ï¼ŒåŸç†æ–‡ç« ç½‘ç»œå¤§æŠŠã€‚

## ç›®æ ‡

æœ¬æ–‡ç›®æ ‡å¦‚ä¸‹ï¼š
- å»ºç«‹ç§æœ‰ä»¥å¤ªåŠï¼Œè®¾ç½®ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ–çŸ¿
- å®Œæˆä¸€ç¬”è½¬è´¦äº¤æ˜“
- å»ºç«‹ç®€å•çš„æ™ºèƒ½åˆçº¦
- å»ºç«‹ç¬¬äºŒä¸ªç½‘ç»œèŠ‚ç‚¹

## ç¯å¢ƒä»‹ç»

æ— è®ºä»€ä¹ˆå¼€å‘éƒ½ç¦»ä¸å¼€ç›¸åº”çš„ç¯å¢ƒï¼Œæˆ‘å°½å¯èƒ½å°†æ‰€æœ‰è½¯ä»¶éƒ½å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä»¥ä¸‹æ˜¯æœ¬æ–‡å†…å®¹ç›¸å…³çš„ç¯å¢ƒï¼š
- æ“ä½œç³»ç»Ÿ MacOS 10.12.6
- Geth ä»¥å¤ªåŠ CLI https://github.com/ethereum/go-ethereum v1.67
- Solidity æ™ºèƒ½åˆçº¦ç¼–è¯‘å™¨ Version: 0.4.15+commit.8b45bddb.Darwin.appleclang

## å®‰è£…

å®‰è£…`Node.js`ï¼Œè¿™é‡Œä¸é˜è¿°äº†ï¼Œæºä»£ç è‡ªå·±ç¼–è¯‘å§ã€‚
å®‰è£…`Geth`ï¼Œè¿™é‡Œç›´æ¥å»å®˜æ–¹ç½‘ç«™ä¸‹è½½æœ€æ–°çš„å¯æ‰§è¡Œç¨‹åºï¼Œå¤åˆ¶åˆ°`/usr/local/bin`ï¼Œå°±OKã€‚
æœ€åå®‰è£…`Solidity`ï¼Œæœ¬åœ°è¦å…ˆæœ‰`brew`ï¼Œæ‰èƒ½è¿›è¡Œå®‰è£…ï¼š
```text
brew tap ethereum/ethereum
brew install solidity
```

## åˆ›å»ºåŒºå—é“¾

åˆ›å»ºè‡ªå·±çš„ä»¥å¤ªåŠç§æœ‰é“¾å¾ˆç®€å•ï¼Œæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œåœ¨ç›®å½•ä¸­å…ˆå»ºç«‹è‡ªå·±çš„åˆ›ä¸–åŒºå—æè¿°`genesis.json`æ–‡ä»¶ã€‚

æ–‡ä»¶å†…å®¹å¦‚ä¸‹

```
{
  "config": {
    "chainId": 2017,
    "homesteadBlock": 0,
    "eip155Block": 0,
    "eip158Block": 0
  },
  "difficulty": "100",
  "gasLimit": "2000000",
  "alloc": {}
}
```

> ä¸ºä»€ä¹ˆè‡ªå·±åˆ›å»ºåˆ›ä¸–åŒºå—æè¿°ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤å€¼ï¼Œ`difficulty`å€¼éå¸¸é«˜ï¼Œè¿™æ ·æŒ–çŸ¿è¦æ€¥æ­»äººçš„ã€‚

é¦–å…ˆåˆ›å»ºä¸¤ä¸ªè´¦æˆ·ï¼Œæœ¬æ–‡åé¢éœ€è¦ç”¨åˆ°è¿™ä¸¤ä¸ªè´¦æˆ·ï¼Œåˆ›å»ºè´¦æˆ·éœ€è¦è¾“å…¥ä¸¤æ¬¡å¯†ç ã€‚

```
ğŸ”¥ > geth --datadir node1 account new
ğŸ”¥ > geth --datadir node1 account new
```

ç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æè¿°æ–‡ä»¶ï¼Œåˆ›å»ºåˆ›ä¸–åŒºå—ã€‚

```
ğŸ”¥ > geth --datadir node1 --networkid 27027 init genesis.json
```

ä½¿ç”¨consoleè¿æ¥èŠ‚ç‚¹1å¹¶ä¸”è®°å½•`log`

```text
ğŸ”¥ > geth --datadir node1 --networkid 27027 console 2>>geth.log
```

## ä½¿ç”¨gethå®ŒæˆæŒ–çŸ¿å’Œäº¤æ˜“

è¿æ¥æˆåŠŸåï¼Œçœ‹çœ‹æœ‰å‡ ä¸ªè´¦æˆ·

```
> eth.accounts
["0x65070d1d224114fd3c8358e9614fd948daecc428", "0xf11167054eb5fb91dd7b46726380f0f0cb09a6d8"]
```

æŸ¥è¯¢ä¸‹è´¦æˆ·ä½™é¢

```
> eth.getBalance(eth.accounts[0])
0
```

ç¬¬ä¸€ä¸ªè´¦æˆ·æ²¡æœ‰ä½™é¢ï¼Œ`accounts[0]`é»˜è®¤æƒ…å†µæ˜¯`coinbase`è´¦æˆ·ï¼Œä¹Ÿå°±æ˜¯æŒ–çŸ¿çš„æ”¶ç›Šå½’é›†è´¦æˆ·ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥æŒ–çŸ¿ï¼Œèµšå–å¥–åŠ±ï¼Œç”±äº`difficulty`å€¼å¾ˆä½ï¼ŒæŒ–çŸ¿ç§’å‡ºåŸºæœ¬ã€‚

```
> miner.start(2);admin.sleepBlocks(1);miner.stop();
true
```

- `miner.start(2)` å¼€å§‹æŒ–çŸ¿ï¼Œå‚æ•°æ˜¯å¼€å¯æŒ–çŸ¿çš„è®¡ç®—çš„çº¿ç¨‹æ•°
- `admin.sleepBlocks(1)` æŒ–åˆ°1ä¸ªåŒºå—å°±åœæ­¢
- `miner.stop()` æŒ–çŸ¿åœæ­¢

ç¬¬ä¸€æ¬¡ä¼šåˆ›å»º`DAG` ï¼Œè¿™é‡Œä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œå…³äº`DAG`ï¼Œè¯¦æƒ…è§åº•éƒ¨å‚è€ƒã€‚å‡ºç°`true`è¯´æ˜æŒ–çŸ¿å®Œæ¯•ï¼ŒæŒ–å®ŒæŸ¥è¯¢ä½™é¢ã€‚

```
> eth.getBalance(eth.accounts[0])
5000000000000000000
```

éœ€è¦æ³¨æ„ï¼ŒæŒ–ä¸€ä¸ªåŒºå—ï¼Œè·å¾—5ä¸ª`ä»¥å¤ªå¸`ä½œä¸ºå¥–åŠ±ï¼Œè¿™é‡Œçš„æ˜¾ç¤ºçš„å•ä½æ˜¯`wei`ï¼Œå¹¶ä¸æ˜¯ä»¥å¤ªå¸ï¼Œä¸‹é¢è½¬æ¢ä¸€ä¸‹

```
> web3.fromWei(eth.getBalance(eth.accounts[0]), 'ether')
5
```

5ä¸ªä»¥å¤ªå¸åœ¨`accounts[0]`ï¼Œç°åœ¨è½¬2ä¸ªç»™`accounts[1]`ï¼Œè½¬è´¦æ—¶å€™ï¼Œå•ä½æ˜¯`wei`ï¼Œä½†æ˜¯æ³¨æ„ï¼Œæ—¢ç„¶è½¬è´¦ï¼Œåˆ«å¿˜å…ˆè§£é”è´¦æˆ·`accounts[0]`ï¼Œè¿™é‡Œè¦è¾“å…¥è´¦æˆ·å¯†ç ã€‚

```
> personal.unlockAccount(eth.accounts[0])
Unlock account 0x65070d1d224114fd3c8358e9614fd948daecc428
Passphrase:
true
> eth.sendTransaction({from: eth.accounts[0], to: eth.accounts[1], value: web3.toWei(2, "ether")})
"0x3f190d2af25dff4e6b6fac9537f8f6152fdb193ca9afe228fbdc9301bbff5645"
```

æœ€åå‡ºç°çš„æ˜¯è¿™ä¸ªäº¤æ˜“çš„`hash`ï¼ŒæŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰å¾…å¤„ç†çš„äº¤æ˜“

```
> txpool.status
{
  pending: 1,
  queued: 0
}
> web3.fromWei(eth.getBalance(eth.accounts[1]), 'ether')
0
```

æœç„¶æœ‰ä¸€ç¬”`pending`ï¼ŒæŸ¥è¯¢è´¦æˆ·`accounts[1]`ï¼Œå¹¶æ²¡æœ‰å‘ç°ä»¥å¤ªå¸ï¼Œè¿™é‡Œéœ€è¦æ—·å·¥æ¥æŒ–çŸ¿ï¼Œæ‰“åŒ…è¿™ä¸ªäº¤æ˜“åˆ°æœ€æ–°åŒºå—ã€‚äº¤æ˜“æ‰èƒ½ç”Ÿæ•ˆï¼Œç»§ç»­æŒ–

```
> miner.start(2);admin.sleepBlocks(1);miner.stop();
true
```

æŸ¥ä¸‹ä½™é¢

```
> web3.fromWei(eth.getBalance(eth.accounts[1]), 'ether')
2
```

å·²ç»åˆ°è´¦ï¼Œå†çœ‹ä¸‹åˆšæ‰äº¤æ˜“çš„è¯¦æƒ…

```
> eth.getTransaction("0x3f190d2af25dff4e6b6fac9537f8f6152fdb193ca9afe228fbdc9301bbff5645")
{
  blockHash: "0xd30fbefb48de05a458a909d9486402bfa4d1459619226a3f8b95aaf407669bb7",
  blockNumber: 2,
  from: "0x65070d1d224114fd3c8358e9614fd948daecc428",
  gas: 90000,
  gasPrice: 18000000000,
  hash: "0x3f190d2af25dff4e6b6fac9537f8f6152fdb193ca9afe228fbdc9301bbff5645",
  input: "0x",
  nonce: 0,
  r: "0xd9b7c4830b9a7ae8ac922179c4e73e6bf2a52178ee0c01250bd940586334d412",
  s: "0xa1b0058b63e1c0360eae6073791b1d63d4a737c71c5932b4b203e853a8185cd",
  to: "0xf11167054eb5fb91dd7b46726380f0f0cb09a6d8",
  transactionIndex: 0,
  v: "0xfe5",
  value: 2000000000000000000
}
```
åˆ°è¿™é‡Œæ•´ä¸ªäº¤æ˜“å°±å®Œæˆäº†

## ç®€å•çš„æ™ºèƒ½åˆçº¦

ä¸‹é¢æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæç®€å•çš„æ™ºèƒ½åˆçº¦ï¼Œ`geth 1.6`å˜åŒ–è›®å¤§çš„ï¼Œä»¥å‰ç¼–è¯‘æ™ºèƒ½åˆçº¦çš„æ–¹æ³•éƒ½æœ‰ä¸€äº›é—®é¢˜ï¼Œæ²¡ä»€ä¹ˆç®€å•çš„åŠæ³•ï¼Œ`browser-solidity`æ˜¯ä¸ªä¸é”™çš„åœ¨çº¿ç¼–è¯‘é€‰æ‹©ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€‰æ‹©åœ¨æœ¬åœ°è¿›è¡Œæ“ä½œï¼Œå‰é¢å·²ç»é€šè¿‡`brew`å®‰è£…äº†`solidity`ï¼Œåˆ›å»ºä¸€ä¸ª`contract`æ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`hello.sol`æ™ºèƒ½åˆçº¦æ–‡ä»¶

```
pragma solidity ^0.4.13;

contract Hello {
  function sum(uint _a, uint _b) returns (uint o_sum, string o_author) {
    o_sum = _a + _b;
    o_author = "freewolf";
  }
}
```

ç„¶åæˆ‘ä»¬æ¥ç¼–è¯‘ï¼Œå®Œæˆåï¼Œä¼šå¤šå‡ºä¸¤ä¸ªæ–‡ä»¶ï¼Œabiæ–‡ä»¶å°±æ˜¯æ™ºèƒ½åˆçº¦ç›¸å…³çš„æ¥å£ï¼Œbinæ–‡ä»¶å°±æ˜¯æ™ºèƒ½åˆçº¦ç¼–è¯‘ä»£ç ã€‚

> è¿™é‡Œæ˜¯Macå‘½ä»¤è¡Œç¯å¢ƒï¼Œä¸æ˜¯gethï¼Œ`ğŸ”¥ > `å¼€å¤´çš„éƒ½æ˜¯å‘½ä»¤è¡Œ

```
ğŸ”¥ > solc -o . --bin --abi hello.sol
ğŸ”¥ > ls
Hello.abi	Hello.bin	hello.sol
```

åœ¨`geth`ä¸­åŠ è½½è¿™äº›æ–‡ä»¶å¾ˆå¤æ‚ï¼Œè¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ä¸‹åˆšç”Ÿæˆçš„æ–‡ä»¶

Hello.abi æ–‡ä»¶å†…å®¹ä¿®æ”¹æˆ

```
var HelloContract = eth.contract([{"constant":false,"inputs":[{"name":"_a","type":"uint256"},{"name":"_b","type":"uint256"}],"name":"sum","outputs":[{"name":"o_sum","type":"uint256"},{"name":"o_author","type":"string"}],"payable":false,"type":"function"}])
```

Hello.bin  æ–‡ä»¶å†…å®¹ä¿®æ”¹æˆ

```
personal.unlockAccount(eth.accounts[0])

var hello = HelloContract.new({
  from: eth.accounts[0],
  data: "0x6060604052341561000f57600080fd5b5b61017a8061001f6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063cad0899b1461003e575b600080fd5b341561004957600080fd5b61006860048080359060200190919080359060200190919050506100eb565b6040518083815260200180602001828103825283818151815260200191508051906020019080838360005b838110156100af5780820151818401525b602081019050610093565b50505050905090810190601f1680156100dc5780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b60006100f561013a565b82840191506040805190810160405280600881526020017f66726565776f6c6600000000000000000000000000000000000000000000000081525090505b9250929050565b6020604051908101604052806000815250905600a165627a7a72305820063cb95e17166637bd4ab62eae6b0e6c4e1fcd85a9c2e3be29aa75a272280b830029",
  gas: 500000
})
```

> æ³¨æ„åˆ«å¿˜äº†dataå¿…é¡»`0x`å¼€å¤´ï¼ŒNewåˆçº¦å°±å¾—è§£é”è‡ªå·±çš„è´¦æˆ·ï¼Œè¿™é‡Œè§£é”ä¹Ÿå†™åœ¨è¿™é‡Œäº†

å›åˆ°`geth`ï¼ŒåŠ è½½åˆšä¿®æ”¹çš„æ–‡ä»¶ï¼ŒåŠ è½½`bin`æ–‡ä»¶éœ€è¦è¾“å…¥è´¦æˆ·å¯†ç 

> æ–‡ä»¶å¤¹`contract`å°±åœ¨è¿è¡Œ`geth`å‘½ä»¤çš„ç›®å½•

```
> loadScript("contract/Hello.abi")
true
> loadScript("contract/Hello.bin")
Unlock account 0x65070d1d224114fd3c8358e9614fd948daecc428
Passphrase:
true
```

ç°åœ¨æ™ºèƒ½åˆçº¦å·²ç»éƒ¨ç½²åˆ°åŒºå—é“¾ä¸Šäº†ï¼Œä½†æ˜¯è¦æŒ–çŸ¿æ‰èƒ½ç”Ÿæ•ˆï¼ŒæŒ–å®Œå°±å¯ä»¥å°½æƒ…ç©è€äº†ã€‚

```
> hello
{
  abi: [{
      constant: false,
      inputs: [{...}, {...}],
      name: "sum",
      outputs: [{...}, {...}],
      payable: false,
      type: "function"
  }],
  address: undefined,
  transactionHash: "0x783f5cae1f9b40f25da1260267d5e6f801d1746541b5f28f84684883723807b8"
}
> hello.sum
undefined
> miner.start(1);admin.sleepBlocks(1);miner.stop();
true
> hello.sum
function()
> hello.sum.call(1,2)
[3, "freewolf"]
```

## è¿½åŠ  - å¦‚ä½•å»ºç«‹å…¶ä»–èŠ‚ç‚¹

è¿½åŠ ä¸€æ®µï¼Œå¦‚ä½•åˆ›å»ºå…¶ä»–çš„`P2P`èŠ‚ç‚¹ï¼Œé¦–å…ˆåœ¨åŸå…ˆèŠ‚ç‚¹æ‰§è¡Œä¸‹é¢ä»£ç ï¼ŒæŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¿¡æ¯

```
> admin.nodeInfo
{
  enode: "enode://bbd3d0f2afad68c3e4b2e79a6daddc6e8498b9266cc3e953bbb121bae40fe44b5e0377c0768b03e47ac04cead52235a12931bfb96528a8225be5808fc8c174b3@192.168.1.2:30303",
  id: "bbd3d0f2afad68c3e4b2e79a6daddc6e8498b9266cc3e953bbb121bae40fe44b5e0377c0768b03e47ac04cead52235a12931bfb96528a8225be5808fc8c174b3",
  ip: "192.168.1.2",
  listenAddr: "[::]:30303",
  name: "Geth/v1.6.7-stable-ab5646c5/darwin-amd64/go1.8.3",
  ports: {
    discovery: 30303,
    listener: 30303
  },
  protocols: {
    eth: {
      difficulty: 655652,
      genesis: "0x7b0286b147e6b5b8710b8acff38053fdf1991a980da8ca73b4b359c28c7144fc",
      head: "0xd545cee3b9247b67c5d43728eddcbcfe9315dcf18cbc12187a7a178220829153",
      network: 27027
    }
  }
}
```

æ‹¿åˆ°nodeç›¸å…³ä¿¡æ¯ï¼Œå°±å¯ä»¥åˆ›å»ºæ–°èŠ‚ç‚¹äº†ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ï¼Œå‰é¢åŸºæœ¬éƒ½ä»‹ç»è¿‡äº†

```
ğŸ”¥ > mkdir node2
ğŸ”¥ > geth --datadir node2 account new
ğŸ”¥ > geth --datadir node2 --networkid 27027 init genesis.json
ğŸ”¥ > geth --datadir node2 --networkid 27027 --port 30304 --bootnodes "enode://bbd3d0f2afad68c3e4b2e79a6daddc6e8498b9266cc3e953bbb121bae40fe44b5e0377c0768b03e47ac04cead52235a12931bfb96528a8225be5808fc8c174b3@192.168.1.2:30303" console
```

éœ€è¦æ³¨æ„çš„ä¹Ÿå°±æ˜¯æœ€åä¸€è¡Œï¼Œå†™å…¥ä½ è‡ªå·±çš„nodeä¿¡æ¯ï¼Œå…¶ä»–çš„ä¹Ÿæ²¡ä»€ä¹ˆäº†ï¼Œè¿›å…¥`geth`åï¼Œæ•°æ®åŒæ­¥åï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤

```
> eth.getBlock('latest')
> admin.peers
```

ä»¥ä¸Šå°±å¯ä»¥åœ¨ç¬¬äºŒä¸ªèŠ‚ç‚¹çœ‹åˆ°ä¹‹å‰èŠ‚ç‚¹1çš„ä¿¡æ¯äº†ã€‚

## å‚è€ƒ & èµ„æº
- å…³äºDAG http://www.hashcash.org/papers/dagger.html
- æ™ºèƒ½åˆçº¦ http://solidity.readthedocs.io/en/develop/solidity-in-depth.html
- æ™ºèƒ½åˆçº¦å¼€å‘IDE https://ethereum.github.io/browser-solidity
